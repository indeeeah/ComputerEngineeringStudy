## 운영체제 구조
---
## CPU Protection Rings
* CPU에 여러가지 명령어가 있는데 CPU도 권한 모드라는 것을 가지고 있다.
    + 사용자 모드(user mode by Application)
    + 커널 모드(kernel mode by OS) : 특권 명령어 실행과 원하는 작업 수행을 위한 자원 접근을 가능케 하는 모드
    + intel CPU는 Ring 0~3 mode가 있다.
        - 대부분은 Ring 3과 Ring 0만 사용을 하고 Ring 3이 사용자 모드이며 Ring 0이 커널 모드라고 한다.

---
## kernel이란?
1. 견과류, 씨앗의 알맹이
2. 사상, 주제의 핵심
3. OS kernel

## shell이란?
1. 껍데기
2. kernel의 껍데기

---
## CPU Protection Rings
### 두 가지 모드
* 사용자 모드 (user mode) : 응용프로그램이 사용
* 커널 모드 (kernel mode) : OS가 사용

---
## 응용프로그램과 운영체제
* 우리가 만ㄷ는 프로그램은 맨 위에서 놀고 있다.
1. 1~1000 더하고 : 시스템 콜을 사용할 필요 없음
2. 파일에서 데이터 가져오기 : 파일을 읽어달라는 시스템 콜을 통해서 커널 영역에서 수행한 뒤에 운영프로그램에 전달한다.
3. 해당 데이터와 1~1000 더한 값을 더하고 출력한다. : 응용프로그램에서 사용됨
* 시스템 콜 위에는 사용자 영역이고, 시스템콜을 이용하는 것은 커널 영역에서 동작한다.

    ||| ||
    |:---:|:---:|:---:|:---:|
    ||User||
    |Apllication|||Shell|
    ||Library or API||
    ||System Call||
    ||Operating System||
    ||Hardware||
    |CPU|Memory|Storyge|Network|

---
## 시스템 콜은 커널 모드에서 실행
* 커널 모드에서만 실행 가능한 기능들이 있음
* 커널 모드로 실행하려면 **반드시 시스템 콜**을 사용해야 함(거쳐야 함)
* 시스템 콜은 운영체제가 제공
* 커널모드에서만 실행 가능한 기능을 응용프로그램에서 쓰려면 시스템 콜을 거쳐서 커널모드로 들어가 CPU에서 실행된다.
* 응용프로그램에서 CPU로 강제로 실행을 시키려고 해도 사용자 모드이기 떄문에 실행조차 되지 않는다.

---
## 사용자모드와 커널 모드
* 함부로 응용 프로그램이 전체 컴퓨터 시스템을 해치지 못함
* 마치 주민등록등본은 꼭 동사무소 또는 민원24시(정부 사이트)에서 특별한 신청서(시스템 콜)를 써야만 발급되는 것과 같은 이치(사용자 모드)
    + 동사무소 직원분들은 특별한 권한을 가지고 주민등록등본 출력 명령을 실행(커널 모드)

---
## 응용 프로그래머와 시스템 프로그래머
* 응용 프로그래머 : API를 가지고 응용 프로그램을 만드는 것
* 시스템 프로그래머 : 운영체제 및 시스템 프로그램, Shell, API제공, 시스템 콜, 하드웨어

---
## Code Example

``` C
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

int main() {
    int fd;
    fd = open("data.txt".O_RDONLY);
    if(fd == -1) {
        printf("Error");
        return 1;
    } else {
        printf("file opened and now close");
        close(fd);
        return ();
    }
}
```

* open()
1. 사용자 모드에서 프로그램 실행
2. open() 시스템 콜 호툴
3. 커널모드로 전환
4. open() 함수를 처리하는 sys_open()(운영체제 안에 있는 함수) 커널 함수 호출
5. 파일 열기로 레벨 연산 수행
6. 사용자 모드로 전환
7. open() 함수 이후의 프로그램을 계속해서 실행

---
## Code Example 2
* 사용자 프로그램
``` C
#include <unisted.h>

main(){
    open();
}
```
> open() 함수 호출

* 헤더파일
``` C
uinstd.h 파일
open 선언
```
> 헤더 파일로 시스템 콜을 사용할 수 있도록 제공

* 커널
``` C
테이블
open() -> sys_open()
```
> open()이 호출되면 sys_open() 함수를 호출하라

---
## 정리
* 운영체제는 **시스템 콜** 제공
* 프로그래밍 언어별로 운영체제 기능을 활용하기 위해, 시스템 콜을 기반으로 API 제공
* 응용프로그램은 운영체제 기능 필용시, 해당 **API**를 사용해서 프로그램을 작성
* 응용프로그램이 실행되서 해당 운영체제 기능이 필요한 **API**를 호출하면 시스템 콜이 호출되서 **커널 모드로 변경되어** OS 내부에서 해당 명령이 실행되고 다시 응용프로그램으로 돌아간다.